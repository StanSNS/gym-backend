name: Azure App Service - gymfitbulgaria-api(Production), Build and deploy Spring app

on:
  push:
    branches:
      - main

jobs:
  terraform-redeploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the different repository with the main.tf file
      - name: 'Checkout Terraform Repo'
        uses: actions/checkout@v2

      # Set up Azure CLI
      - name: 'Login to Azure'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Set up Terraform
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.7

      # Initialize Terraform
      - name: Terraform Init
        working-directory: ./infra
        run: terraform init

      # Execute Terraform Destroy targeting specific resources
      - name: Terraform Destroy Targeting Specific Resources
        working-directory: ./infra
        run: terraform destroy -auto-approve -target=azurerm_windows_web_app.awwabs

      # Execute Terraform Apply targeting specific resources
      - name: Terraform Apply Targeting Specific Resources
        working-directory: ./infra
        run: terraform apply -auto-approve -target=azurerm_windows_web_app.awwabs

      # Configure Git
      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # Commit and push updated terraform.tfstate
      - name: Commit and Push State File
        run: |
          git add .
          git commit -m "Update terraform.tfstate after destroy"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN}}

      - name: Set up Java version
        uses: actions/setup-java@v1
        with:
          java-version: '17'

      - name: Build with Maven
        run: mvn clean install

#      - name: Run Azure webapp deploy action using publish profile credentials
#        uses: azure/webapps-deploy@v2
#        with:
#          app-name: gymfitbulgaria-api
#          slot-name: Production
#          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_0EC7C6B52D3F436B824D707339550EA5 }}
#          package: ${{ github.workspace }}/target/*.jar





#  build-and-deploy:
#    runs-on: windows-latest
#    needs: terraform-destroy
#
#    steps:
#    # checkout the repo
#    - name: 'Checkout Github Action'
#      uses: actions/checkout@master
#
#
#    - name: Set up Java version
#      uses: actions/setup-java@v1
#      with:
#        java-version: '17'
#
#    - name: Build with Maven
#      run: mvn clean install
#
#    - name: Run Azure webapp deploy action using publish profile credentials
#      uses: azure/webapps-deploy@v2
#      with:
#        app-name: gymfitbulgaria-api
#        slot-name: Production
#        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_0EC7C6B52D3F436B824D707339550EA5 }}
#        package: ${{ github.workspace }}/target/*.jar

